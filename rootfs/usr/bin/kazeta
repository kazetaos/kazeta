#! /bin/bash

set -x

BASE_DIR="$HOME/.local/share/kazeta"
if [[ ! -d "${BASE_DIR}" ]]; then
	mkdir -p "${BASE_DIR}"
fi

BASE_EXT="/media"
result=$(ls -1 /media | wc -l)
if [[ "$result" == "0" ]]; then
	BASE_EXT="/run/media/${USER}"
	if [[ ! -d "${BASE_EXT}" ]]; then
		BASE_EXT="/run/media"
	fi
fi

function get_attribute {
	attribute=$1
	shift
	info_file="$@"
	cat "${info_file}" | grep "^${attribute}=" | head -1 | cut -d= -f2-
}

function start_playtime_capture {
	echo "running" > /tmp/kazeta_playtime_capture_state
	while [ "$(cat /tmp/kazeta_playtime_capture_state)" == "running" ]; do
		sleep 60 &
		echo $! > /tmp/kazeta_playtime_capture_sleep_pid
		wait
		date --iso-8601=seconds > .kazeta/var/playtime_end
	done
	echo "done" > /tmp/kazeta_playtime_capture_state
}

function stop_playtime_capture {
	echo "shutdown" > /tmp/kazeta_playtime_capture_state
	kill $(cat /tmp/kazeta_playtime_capture_sleep_pid)
	while [ "$(cat /tmp/kazeta_playtime_capture_state)" != "done" ]; do
		sleep 0.001
	done
}

function cleanup {
	stop_playtime_capture
	popd
	pkexec kazeta-mount --unmount "${target}" "${runtimedir}"
	pkexec kazeta-mount kzp --unmount "${cart_path}"
	rm -rf "${upper}/.kazeta/share"
	rmdir --ignore-fail-on-non-empty "${upper}/.kazeta"
}

# wait up to 2 seconds for a cart
for i in $(seq 1 20); do
	cart_info=$(find ${BASE_EXT} -maxdepth 2 -name "*.kzi" | head -1)
	cart_pkg=$(find ${BASE_EXT} -maxdepth 2 -name "*.kzp" | head -1)
	if [[ -f "${cart_info}" ]] || [[ -f "${cart_pkg}" ]]; then
		break
	else
		sleep 0.1
	fi
done

if [[ ! -f "${cart_info}" ]] && [[ ! -f "${cart_pkg}" ]]; then
	# no cart found, start bios/memory management app
	gamescope --filter pixel -- kazeta-bios
	exit 0
fi

if [[ -f "${cart_pkg}" ]]; then
	cart_path="${BASE_DIR}/run/pkg"
	mkdir -p "${cart_path}"
	pkexec kazeta-mount kzp "${cart_pkg}" "${cart_path}"
	cart_info=$(find "${cart_path}" -maxdepth 2 -name "*.kzi" | head -1)
	media_path=$(dirname "${cart_pkg}")
else
	cart_path=$(dirname "${cart_info}")
	media_path="${cart_path}"
fi

cart_id="$(get_attribute 'Id' ${cart_info})"
cart_icon="${cart_path}/$(get_attribute 'Icon' ${cart_info})"

mkdir -p "${BASE_DIR}/cache/${cart_id}"
cp "${cart_info}" "${BASE_DIR}/cache/${cart_id}/metadata.kzi"
if [[ -f "${cart_icon}" ]]; then
	cp "${cart_icon}" "${BASE_DIR}/cache/${cart_id}/icon.png"
fi

lower="${cart_path}"
upper="${BASE_DIR}/saves/default/${cart_id}"
work="${BASE_DIR}/run/work"
target="${BASE_DIR}/run/cart"

if [[ ! -d "${upper}" ]]; then
	rm -f "${upper}"
	mkdir -p "${upper}"
fi

#Directory for all internal runtimes
internal_runtime="/usr/share/kazeta/runtimes/"

runtime_name="$(get_attribute 'Runtime' ${cart_info})"
if [ -n "$runtime_name" ]; then
	#Checking internal path for matching runtime
	runtime="${internal_runtime}/${runtime_name}.kzr"
	if [ ! -f "$runtime" ]; then
		runtime="$(ls ${internal_runtime}/${runtime_name}-*.kzr)"
		#Checking cart path for matching runtime
		if [ ! -f "$runtime" ]; then
			runtime="${media_path}/${runtime_name}"
			if [ ! -f "$runtime" ]; then
				runtime="${media_path}/${runtime_name}.kzr"
				if [ ! -f "$runtime" ]; then
					runtime="$(ls ${media_path}/${runtime_name}-*.kzr)"
					if [ ! -f "$runtime" ]; then
						runtime="{$internal_runtime}/none.kzr"
					fi
				fi
			fi
		fi
	fi
else
	runtime="{$internal_runtime}/none.kzr"
fi

runtimedir="${BASE_DIR}/run/runtime"
pkexec kazeta-mount "${lower}" "${upper}" "${work}" "${target}" "${runtime}" "${runtimedir}"
trap cleanup EXIT

export HOME="${BASE_DIR}/run/cart"

unset XDG_CONFIG_HOME
unset XDG_CACHE_HOME
unset XDG_DATA_HOME
unset XDG_STATE_HOME
pushd "${HOME}"

cart_exec="$(get_attribute 'Exec' ${cart_info})"
cart_gsopts="$(get_attribute 'GamescopeOptions' ${cart_info})"
echo "$cart_exec" > /tmp/kazeta-cart-exec

# append previously captured playtime to the log
if [ -f .kazeta/var/playtime_start ] && [ -f .kazeta/var/playtime_end ]; then
	echo "$(cat .kazeta/var/playtime_start) $(cat .kazeta/var/playtime_end)" >> .kazeta/var/playtime.log
fi
rm -f .kazeta/var/playtime_start
rm -f .kazeta/var/playtime_end

mkdir -p .kazeta/var
date --iso-8601=seconds > .kazeta/var/playtime_start
start_playtime_capture &
gamescope ${cart_gsopts} -- ./.kazeta/share/run /tmp/kazeta-cart-exec | grep -v "pressure-vessel-wrap" > "${HOME}/.kazeta/var/run.log" 2>&1
